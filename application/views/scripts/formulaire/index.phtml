<?php
$arrayKeys = array_keys($this->formulaires);
$lastKey = end($arrayKeys);
?>
<ul class="nav nav-tabs">
    <li class="active"><a href="#etablissements" data-toggle="tab">Etablissements</a></li>
    <li><a href="#dossiers" data-toggle="tab">Dossiers</a></li>
</ul>

<div class="tab-content">
    <div class="tab-pane active" id="etablissements">
        <?php foreach ($this->formulaires as $key => $formulaire) : ?>
            <?php if ($formulaire['NOM_INTERNE'] == 'effectifsDegagementsEtablissement' || $formulaire['NOM_INTERNE'] == 'descriptifEtablissement') : ?>
                <div id="<?= $formulaire['NOM_INTERNE'] ?>" class="row-fluid objet">
                    <div class="span12">
                        <div>
                            <h2 style="display: inline;" id="nom_<?= $formulaire['ID_CAPSULERUBRIQUE'] ?>">
                                <?= $formulaire['NOM'] ?>
                            </h2>
                            <a data-toggle="modal" data-target="#editModal_<?= $formulaire['ID_CAPSULERUBRIQUE'] ?>">
                                <i title='Modifier' class="icon-pencil icon-black" style="margin-left: 10px;"></i>
                            </a>
                        </div>
                        <?php include 'partials/partial-modal-editNom-capsuleRubrique.phtml'; ?>
                        <?php include 'partials/partial-infos-rubriques.phtml'; ?>
                    </div>
                    <?php if ($key !== $lastKey) : ?>
                        <hr>
                    <?php endif; ?>
                </div>
            <?php endif; ?>
        <?php endforeach; ?>
    </div>

    <div class="tab-pane" id="dossiers">
        <?php foreach ($this->formulaires as $key => $formulaire) : ?>
            <?php if ($formulaire['NOM_INTERNE'] != 'effectifsDegagementsEtablissement' && $formulaire['NOM_INTERNE'] != 'descriptifEtablissement') : ?>
                <div id="<?= $formulaire['NOM_INTERNE'] ?>" class="row-fluid objet">
                    <div class="span12">
                        <div>
                            <h2 style="display: inline;" id="nom_<?= $formulaire['ID_CAPSULERUBRIQUE'] ?>">
                                <?= $formulaire['NOM'] ?>
                            </h2>
                            <a data-toggle="modal" data-target="#editModal_<?= $formulaire['ID_CAPSULERUBRIQUE'] ?>">
                                <i title='Modifier' class="icon-pencil icon-black" style="margin-left: 10px;"></i>
                            </a>
                        </div>
                        <?php include 'partials/partial-modal-editNom-capsuleRubrique.phtml'; ?>
                        <?php include 'partials/partial-infos-rubriques.phtml'; ?>
                    </div>
                    <?php if ($key !== $lastKey) : ?>
                        <hr>
                    <?php endif; ?>
                </div>
            <?php endif; ?>
        <?php endforeach; ?>
    </div>
</div>

<script>
    $(document).ready(function() {
        <?php foreach ($this->formulaires as $formulaire) : ?>
            $('#editForm_<?= $formulaire['ID_CAPSULERUBRIQUE'] ?>').on('submit', function(e) {
                e.preventDefault();
                var newName = $('#newName_<?= $formulaire['ID_CAPSULERUBRIQUE'] ?>').val();
                if (newName) {
                    $.ajax({
                        url: '<?= $this->url(['controller' => 'formulaire', 'action' => 'edit-nom'], null, true) ?>',
                        type: 'POST',
                        data: {
                            id: <?= $formulaire['ID_CAPSULERUBRIQUE'] ?>,
                            newName: newName
                        },
                        dataType: 'json',
                        success: function(response) {
                            if (response.status === 'success') {
                                $('#nom_<?= $formulaire['ID_CAPSULERUBRIQUE'] ?>').text(newName);

                                $('#editModal_<?= $formulaire['ID_CAPSULERUBRIQUE'] ?>').modal('hide');
                            } else {
                                alert('Une erreur est survenue lors de la mise à jour : ' + response.message);
                            }
                        },
                        error: function() {
                            alert('Une erreur est survenue lors de la requête.');
                        }
                    });
                } else {
                    alert('Le nom ne peut pas être vide.');
                }
            });
        <?php endforeach; ?>
    });
</script>